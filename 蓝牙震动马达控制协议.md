# 蓝牙震动马达控制协议（V3.0）
> 标准 LE Secure Connections + Just-Works 实现

---

## 1 协议目标
- 标准 BLE 安全：LESC + Just-Works
- 用户交互极简：首次 1 次系统弹窗，后续秒连
- 单包完成占空比设置
- 无应用层安全逻辑，完全依赖 BLE 协议栈

---

## 2 绑定与加密流程
| 步骤 | 动作 | 备注 |
|---|---|---|
| 1 | 玩具广播 `ADV_IND` | 含 Flag LE General Discoverable |
| 2 | 手机连接 | 任意中央设备 |
| 3 | BLE 协议栈自动触发 LESC 配对 | `slave_set_wait_security = 1` |
| 4 | 系统弹窗"是否配对 **××震动玩具**？" | Just-Works，无 PIN |
| 5 | 配对成功 → BLE 协议栈存储 LTK | 自动管理 |
| 6 | 后续再连 | 自动加密复用，**零弹窗** |

---

## 3 GATT 服务定义
| 字段 | 值 |
|---|---|
| Service UUID | `9A501A2D-594F-4E2B-B123-5F739A2D594F` |
| **Motor Control Char UUID** | `9A511A2D-594F-4E2B-B123-5F739A2D594F` |
| Property | Write-Without-Response |
| **Device Info Char UUID** | `9A521A2D-594F-4E2B-B123-5F739A2D594F` |
| Property | Write, Notify |
| Security | Encryption Required (enforced by stack) |
| MTU 需求 | 23 B 即可 |

---

## 4 数据包格式

### 4.1 马达控制（手机 → 玩具）
**Characteristic**: `9A511A2D-594F-4E2B-B123-5F739A2D594F`  
固定 **2 B**

| 偏移 | 长度 | 名称 | 类型 | 说明 |
|---|---|---|---|---|
| 0 | 2 | `duty_cycle` | uint16 | 0-10000 → 0.00%-100.00% (little-endian) |

**极简设计**: 无命令字节，无计数器，无保留字段

### 4.2 设备信息查询（手机 ↔ 玩具）
**Characteristic**: `9A521A2D-594F-4E2B-B123-5F739A2D594F`

#### 4.2.1 查询请求（手机 → 玩具）
固定 **2 B**

| 偏移 | 长度 | 名称 | 值 | 说明 |
|---|---|---|---|---|
| 0 | 1 | `header` | 0xB0 | 协议头 |
| 1 | 1 | `cmd` | 0x00 | 查询设备信息命令 |

#### 4.2.2 查询响应（玩具 → 手机）
固定 **6 B**

| 偏移 | 长度 | 名称 | 类型 | 说明 |
|---|---|---|---|---|
| 0 | 1 | `header` | 0xB0 | 协议头 |
| 1 | 1 | `cmd` | 0x00 | 响应命令 |
| 2 | 1 | `motor_count` | uint8 | 马达数量（当前固定为 1） |
| 3 | 1 | `fw_version_low` | uint8 | 固件版本低字节 |
| 4 | 1 | `fw_version_high` | uint8 | 固件版本高字节 |
| 5 | 1 | `battery_level` | uint8 | 电池电量 0-100 (%) |

**示例**:
- 固件版本 1.2 → `fw_version_high=1, fw_version_low=2`
- 电池 85% → `battery_level=85`

---

## 5 安全机制
**完全由 BLE 协议栈提供:**
- **链路加密**: AES-CCM 128-bit（自动）
- **密钥交换**: P-256 ECDH（LESC）
- **重放保护**: 链路层 Packet Counter（自动）
- **数据完整性**: AES-CCM MIC（自动）
- **密钥存储**: LTK 由协议栈管理（自动）

**应用层无需任何安全逻辑**

---

## 6 设备端处理流程（伪代码）

### 6.1 马达控制处理
```c
/* BLE 协议栈确保只有加密连接才能写入 */
void motor_control_write_callback(uint8_t *data, uint16_t len) {
    if (len != 2) return ATT_ERR_INVALID_PDU;
    
    uint16_t duty = data[0] | (data[1] << 8);
    if (duty > 10000) return ATT_ERR_VALUE_NOT_ALLOWED;
    
    set_pwm_duty(duty);
    return ATT_ERR_SUCCESS;
}
```

### 6.2 设备信息查询处理
```c
void device_info_write_callback(uint8_t *data, uint16_t len) {
    if (len != 2) return ATT_ERR_INVALID_PDU;
    if (data[0] != 0xB0 || data[1] != 0x00) return ATT_ERR_VALUE_NOT_ALLOWED;
    
    uint8_t response[6] = {
        0xB0,                    // header
        0x00,                    // cmd
        0x01,                    // motor_count (1 motor)
        FIRMWARE_VERSION_LOW,    // fw_version_low
        FIRMWARE_VERSION_HIGH,   // fw_version_high
        get_battery_level()      // battery_level (0-100)
    };
    
    send_notification(response, 6);
    return ATT_ERR_SUCCESS;
}
```

**就这么简单！** 无状态管理，无 Flash 操作，无计数器

---

## 7 安全声明
| 项目 | 实现 |
|---|---|
| 链路加密 | AES-CCM 128-bit（BLE 协议栈） |
| 密钥交换 | P-256 ECDH（LESC） |
| 认证方式 | Just-Works（无 MITM） |
| 重放保护 | 链路层 Packet Counter（BLE 协议栈） |
| 数据完整性 | AES-CCM MIC（BLE 协议栈） |
| 密钥存储 | LTK 由 BLE 协议栈管理 |

---

## 8 发布 checklist
- [ ] 固件配置 `slave_set_wait_security = 1`（强制加密）
- [ ] 固件配置 `authentication_req_flags = SM_AUTHREQ_BONDING | SM_AUTHREQ_SECURE_CONNECTION`
- [ ] 固件配置 `io_capabilities = IO_CAPABILITY_NO_INPUT_NO_OUTPUT`
- [ ] 量产时开启芯片 RDP / APPROTECT
- [ ] App 端扫描过滤 Service UUID `9A501A2D-594F-4E2B-B123-5F739A2D594F`
